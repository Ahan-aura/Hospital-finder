<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Doctor Dashboard - Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0A6E7C; 
            --secondary-bg: #EAF4F6;
        }
        .text-primary-blue { color: var(--primary-blue); }
        .bg-primary-blue { background-color: var(--primary-blue); }
        .hover\:bg-primary-dark:hover { background-color: #07525C; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F7F7F7;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(10, 110, 124, 0.4); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary-blue">
                <span class="text-4xl mr-1">&#9992;</span> <span id="header-specialty"></span> Dashboard
            </h1>
            <div class="flex items-center space-x-4">
                <span id="doctor-name-display" class="font-medium text-gray-700 hidden sm:inline"></span>
                <button onclick="window.location.href='index.html'" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">Logout</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        <div class="flex flex-col lg:flex-row gap-8">

            <div class="lg:w-1/4 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">Today is:</h2>
                    <p id="current-date" class="text-3xl font-bold text-primary-blue mt-1"></p>
                    <p class="text-sm text-gray-500 mt-2">Specialty: <span id="sidebar-specialty"></span></p>
                    <button class="w-full mt-4 py-2 text-sm bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition">
                        Manage Availability
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-3">
                    <h2 class="text-lg font-semibold text-gray-800">Quick Tools</h2>
                    <input type="text" id="patient-search" placeholder="Search Patient Name..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                    <button class="w-full py-2 text-white bg-green-500 hover:bg-green-600 rounded-lg transition">
                        + Manual Appointment
                    </button>
                    <button class="w-full py-2 text-white bg-gray-500 hover:bg-gray-600 rounded-lg transition">
                        View Past Records
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">Daily Reminders</h2>
                    <textarea placeholder="e.g., Follow up on R.S.'s blood test." class="w-full h-24 mt-2 p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue resize-none"></textarea>
                </div>
            </div>

            <div class="lg:w-3/4 space-y-8">
                <h1 class="text-3xl font-extrabold text-gray-900">Today's Appointment Schedule</h1>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-primary-blue">
                        <p class="text-sm font-medium text-gray-500">Total Today</p>
                        <p id="stat-total" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Completed</p>
                        <p id="stat-completed" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Pending</p>
                        <p id="stat-pending" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-4 bg-white p-4 rounded-xl shadow-md border border-gray-100">
                    <label for="status-filter" class="font-medium text-gray-700">Filter by Status:</label>
                    <select id="status-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        <option value="All">Show All</option>
                        <option value="Checked In">Checked In</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Blocked">Blocked</option>
                    </select>

                    <label for="type-sort" class="font-medium text-gray-700">Sort By:</label>
                    <select id="type-sort" class="p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        <option value="time-asc">Time (Earliest First)</option>
                        <option value="name-asc">Patient Name (A-Z)</option>
                    </select>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-4 text-xl font-bold text-gray-800 border-b">Appointment Details</div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Visit Reason</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Symptoms</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appointment-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="p-6 text-center text-gray-500">Initializing database connection...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="p-8"></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, doc, updateDoc, Timestamp, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ========================================================================
        // ðŸš¨ STEP 1: CONFIGURATION - GENERAL PRACTITIONER ðŸš¨
        // ========================================================================

        const DOCTOR_NAME = "Dr. Kavya Rao";
        const DOCTOR_SPECIALTY = "General Practice (GP)";
        
        // Define an array of specialties this doctor handles (the "rest" of them).
        const FILTER_SPECIALTIES = [
            "Family Medicine", 
            "Orthopedics", 
            "Pulmonology",
            "General Health Check",
            "Bone & Joint Care",
            "Lungs & Breathing Health"
        ]; 

        // Firebase Configuration (Same as Patient Page)
        const firebaseConfig = {
            apiKey: "AIzaSyDKd59GeEC9TUZYKWjouyfppRwnkJSxxUQ",
            authDomain: "appo-e6f45.firebaseapp.com",
            projectId: "appo-e6f45",
            storageBucket: "appo-e6f45.appspot.com",
            messagingSenderId: "123701876241",
            appId: "1:123701876241:web:201c7e2ccb0c2ca6f703b0",
            measurementId: "G-B39GZ9YB22"
        };
        // ========================================================================
        // ðŸ›‘ END CONFIGURATION ðŸ›‘
        // ========================================================================


        let db;
        let currentAppointments = []; // Stores the raw data from Firestore

        // --- UTILITY FUNCTIONS (Standard) ---

        /** Returns the Tailwind classes for a given status */
        function getStatusClasses(status) {
            switch (status) {
                case 'Checked In': return 'bg-yellow-100 text-yellow-800 border-yellow-500';
                case 'Completed': return 'bg-green-100 text-green-800 border-green-500';
                case 'Cancelled': return 'bg-red-100 text-red-800 border-red-500';
                case 'confirmed': 
                case 'Scheduled': return 'bg-blue-100 text-blue-800 border-blue-500';
                case 'Blocked': return 'bg-gray-200 text-gray-600 border-gray-400';
                default: return 'bg-gray-100 text-gray-800 border-gray-300';
            }
        }

        /** Updates the count cards on the dashboard */
        function updateStats(filteredList) {
            const today = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' });
            
            // Only count appointments scheduled for today
            const todayAppointments = filteredList.filter(appt => {
                const apptDate = appt.dateTime?.toDate ? new Date(appt.dateTime.toDate()).toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' }) : appt.date;
                return apptDate === today;
            });
            
            const total = todayAppointments.length;
            const completed = todayAppointments.filter(a => a.status === 'Completed').length;
            const pending = todayAppointments.filter(a => a.status !== 'Completed' && a.status !== 'Cancelled' && a.status !== 'Blocked').length; 

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-pending').textContent = Math.max(0, pending);
        }

        /** Formats Firebase Timestamp to "HH:MM AM/PM" */
        function formatFirebaseTimestamp(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') return { time: 'N/A', date: 'N/A' };
            const date = timestamp.toDate();
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const dateStr = date.toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' });
            return { time: timeStr, date: dateStr };
        }
        
        /** Renders the list of appointments to the table */
        function renderSchedule(data) {
            const listElement = document.getElementById('appointment-list');
            listElement.innerHTML = ''; // Clear existing entries

            if (data.length === 0) {
                listElement.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-500">No upcoming appointments matched the General Practice filter.</td></tr>`;
                updateStats([]);
                return;
            }

            data.forEach(appt => {
                const statusClasses = getStatusClasses(appt.status);
                const isActionable = appt.status !== 'Completed' && appt.status !== 'Cancelled' && appt.status !== 'Blocked';
                
                const formattedTime = appt.formattedTime || appt.time || 'N/A';
                const patientName = appt.patientName || 'Unknown Patient';
                const reasonOrDoctor = appt.doctor || 'Not specified'; // Using doctor field as visit reason
                const symptoms = appt.symptoms || 'â€”';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150 ease-in-out';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">${formattedTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-primary-blue font-medium cursor-pointer hover:underline">${patientName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden sm:table-cell">${reasonOrDoctor}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden md:table-cell">${symptoms}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 inline-flex text-xs leading-5 font-semibold rounded-full border ${statusClasses}">
                            ${appt.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        ${isActionable ? `
                            <button onclick="window.updateStatus('${appt.id}', 'Completed')" class="text-white bg-green-500 hover:bg-green-600 px-3 py-1 rounded-full text-xs transition mr-2">Complete</button>
                            <button onclick="window.updateStatus('${appt.id}', 'Cancelled')" class="text-red-500 hover:text-red-700 font-medium text-xs">Cancel</button>
                        ` : appt.status === 'Completed' ? '<span class="text-green-600">Reviewed</span>' : 'â€”'}
                    </td>
                `;
                listElement.appendChild(row);
            });
            updateStats(data);
        }

        // Must be attached to window to be callable from HTML button's onclick
        window.updateStatus = async function(id, newStatus) {
            if (!db) return;
            try {
                const apptRef = doc(db, 'appointments', id);
                await updateDoc(apptRef, {
                    status: newStatus
                });
                console.log(`Appointment ${id} updated to: ${newStatus}`);
            } catch (error) {
                console.error("Error updating document: ", error);
                alert(`Failed to update status: ${error.message}`);
            }
        }


        /** Combines filtering and sorting before rendering */
        function applyFiltersAndSort() {
            const statusFilter = document.getElementById('status-filter').value;
            const sortType = document.getElementById('type-sort').value;
            const searchTerm = document.getElementById('patient-search').value.toLowerCase();

            let filtered = currentAppointments.slice(); // Use the global copy of data

            // 1. Filtering by Status
            if (statusFilter !== 'All') {
                filtered = filtered.filter(appt => appt.status === statusFilter);
            }

            // 2. Search by Patient Name
            if (searchTerm) {
                filtered = filtered.filter(appt => 
                    (appt.patientName || '').toLowerCase().includes(searchTerm)
                );
            }

            // 3. Sorting (based on the original Timestamp)
            if (sortType === 'time-asc') {
                filtered.sort((a, b) => a.sortableDate - b.sortableDate);
            } else if (sortType === 'name-asc') {
                filtered.sort((a, b) => (a.patientName || '').localeCompare(b.patientName || ''));
            }

            renderSchedule(filtered);
        }

        /** Sets up the real-time connection to Firebase Firestore */
        function setupRealtimeListener() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const q = query(
                collection(db, 'appointments'),
                orderBy('dateTime', 'asc') // Order by date/time
            );
            
            const specialtiesLower = FILTER_SPECIALTIES.map(s => s.toLowerCase());

            onSnapshot(q, (snapshot) => {
                const allAppointments = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const apptDate = data.dateTime?.toDate ? new Date(data.dateTime.toDate()) : (data.date ? new Date(data.date) : null);
                    
                    if (apptDate && apptDate.getTime() >= Date.now() - (24 * 60 * 60 * 1000)) { // Show upcoming/today
                        
                        // Check if the appointment's 'doctor' or 'symptoms' field
                        // contains ANY of the general specialty strings.
                        const doctorDetails = (data.doctor || '').toLowerCase();
                        const symptoms = (data.symptoms || '').toLowerCase();
                        
                        let isMatch = false;
                        for (const specialty of specialtiesLower) {
                            if (doctorDetails.includes(specialty) || symptoms.includes(specialty)) {
                                isMatch = true;
                                break;
                            }
                        }
                        
                        // Also, ensure it's not one of the *other* specialties (Cardiology, Dentistry, Neurology)
                        // A truly robust system would need a dedicated 'specialty' field in the database, 
                        // but given the current form structure, this prevents overlap.
                        const excludedSpecialties = ["cardiology", "dentistry", "neurology"];
                        let isExcluded = false;
                        for (const excl of excludedSpecialties) {
                            if (doctorDetails.includes(excl)) {
                                isExcluded = true;
                                break;
                            }
                        }


                        if (isMatch && !isExcluded) {
                            const formatted = formatFirebaseTimestamp(data.dateTime);
                            const sortableDate = apptDate.getTime();

                            allAppointments.push({ 
                                id: doc.id, 
                                sortableDate, 
                                formattedTime: formatted.time,
                                ...data 
                            });
                        }
                    }
                });
                
                currentAppointments = allAppointments;
                applyFiltersAndSort(); // Re-apply current filters and render the new data
            }, (error) => {
                console.error("Error listening to appointments: ", error);
                document.getElementById('appointment-list').innerHTML = '<tr><td colspan="6" class="p-6 text-center text-red-500">Failed to load schedule from database.</td></tr>';
            });
        }

        // --- INITIALIZATION ---
        function initializeAppAndAuth() {
            // Set up UI text based on configuration
            document.getElementById('page-title').textContent = `${DOCTOR_SPECIALTY} Dashboard`;
            document.getElementById('header-specialty').textContent = `${DOCTOR_SPECIALTY}`;
            document.getElementById('sidebar-specialty').textContent = `${DOCTOR_SPECIALTY}`;
            document.getElementById('doctor-name-display').textContent = `${DOCTOR_NAME}, ${DOCTOR_SPECIALTY}`;

            // Set current date
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-IN', dateOptions);

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setupRealtimeListener();
            } catch (error) {
                console.error("Initialization Error:", error);
                document.getElementById('appointment-list').innerHTML = `<tr><td colspan="6" class="p-6 text-center text-red-500">App Setup Failed: ${error.message}</td></tr>`;
            }

            // Set up event listeners for filters/search
            document.getElementById('status-filter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('type-sort').addEventListener('change', applyFiltersAndSort);
            document.getElementById('patient-search').addEventListener('input', applyFiltersAndSort);
        }
        
        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Doctor Dashboard - Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #0A6E7C; 
            --secondary-bg: #EAF4F6;
        }
        .text-primary-blue { color: var(--primary-blue); }
        .bg-primary-blue { background-color: var(--primary-blue); }
        .hover\:bg-primary-dark:hover { background-color: #07525C; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F7F7F7;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(10, 110, 124, 0.4); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="min-h-screen">

    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary-blue">
                <span class="text-4xl mr-1">&#9992;</span> <span id="header-specialty"></span> Dashboard
            </h1>
            <div class="flex items-center space-x-4">
                <span id="doctor-name-display" class="font-medium text-gray-700 hidden sm:inline"></span>
                <button onclick="window.location.href='index.html'" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition">Logout</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-4 md:p-8">
        <div class="flex flex-col lg:flex-row gap-8">

            <div class="lg:w-1/4 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">Today is:</h2>
                    <p id="current-date" class="text-3xl font-bold text-primary-blue mt-1"></p>
                    <p class="text-sm text-gray-500 mt-2">Specialty: <span id="sidebar-specialty"></span></p>
                    <button class="w-full mt-4 py-2 text-sm bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition">
                        Manage Availability
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 space-y-3">
                    <h2 class="text-lg font-semibold text-gray-800">Quick Tools</h2>
                    <input type="text" id="patient-search" placeholder="Search Patient Name..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                    <button class="w-full py-2 text-white bg-green-500 hover:bg-green-600 rounded-lg transition">
                        + Manual Appointment
                    </button>
                    <button class="w-full py-2 text-white bg-gray-500 hover:bg-gray-600 rounded-lg transition">
                        View Past Records
                    </button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800">Daily Reminders</h2>
                    <textarea placeholder="e.g., Follow up on R.S.'s blood test." class="w-full h-24 mt-2 p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue resize-none"></textarea>
                </div>
            </div>

            <div class="lg:w-3/4 space-y-8">
                <h1 class="text-3xl font-extrabold text-gray-900">Today's Appointment Schedule</h1>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-primary-blue">
                        <p class="text-sm font-medium text-gray-500">Total Today</p>
                        <p id="stat-total" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500">Completed</p>
                        <p id="stat-completed" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-red-500">
                        <p class="text-sm font-medium text-gray-500">Pending</p>
                        <p id="stat-pending" class="text-3xl font-extrabold text-gray-900 mt-1">0</p>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-4 bg-white p-4 rounded-xl shadow-md border border-gray-100">
                    <label for="status-filter" class="font-medium text-gray-700">Filter by Status:</label>
                    <select id="status-filter" class="p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        <option value="All">Show All</option>
                        <option value="Checked In">Checked In</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                        <option value="Blocked">Blocked</option>
                    </select>

                    <label for="type-sort" class="font-medium text-gray-700">Sort By:</label>
                    <select id="type-sort" class="p-2 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                        <option value="time-asc">Time (Earliest First)</option>
                        <option value="name-asc">Patient Name (A-Z)</option>
                    </select>
                </div>

                <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                    <div class="p-4 text-xl font-bold text-gray-800 border-b">Appointment Details</div>
                    <div class="overflow-x-auto custom-scrollbar">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Visit Reason</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden md:table-cell">Symptoms</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="appointment-list" class="bg-white divide-y divide-gray-200">
                                <tr><td colspan="6" class="p-6 text-center text-gray-500">Initializing database connection...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <footer class="p-8"></footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, doc, updateDoc, Timestamp, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ========================================================================
        // ðŸš¨ STEP 1: CONFIGURATION - GENERAL PRACTITIONER ðŸš¨
        // ========================================================================

        const DOCTOR_NAME = "Dr. Kavya Rao";
        const DOCTOR_SPECIALTY = "General Practice (GP)";
        
        // Define an array of specialties this doctor handles (the "rest" of them).
        const FILTER_SPECIALTIES = [
            "Family Medicine", 
            "Orthopedics", 
            "Pulmonology",
            "General Health Check",
            "Bone & Joint Care",
            "Lungs & Breathing Health"
        ]; 

        // Firebase Configuration (Same as Patient Page)
        const firebaseConfig = {
            apiKey: "AIzaSyDKd59GeEC9TUZYKWjouyfppRwnkJSxxUQ",
            authDomain: "appo-e6f45.firebaseapp.com",
            projectId: "appo-e6f45",
            storageBucket: "appo-e6f45.appspot.com",
            messagingSenderId: "123701876241",
            appId: "1:123701876241:web:201c7e2ccb0c2ca6f703b0",
            measurementId: "G-B39GZ9YB22"
        };
        // ========================================================================
        // ðŸ›‘ END CONFIGURATION ðŸ›‘
        // ========================================================================


        let db;
        let currentAppointments = []; // Stores the raw data from Firestore

        // --- UTILITY FUNCTIONS (Standard) ---

        /** Returns the Tailwind classes for a given status */
        function getStatusClasses(status) {
            switch (status) {
                case 'Checked In': return 'bg-yellow-100 text-yellow-800 border-yellow-500';
                case 'Completed': return 'bg-green-100 text-green-800 border-green-500';
                case 'Cancelled': return 'bg-red-100 text-red-800 border-red-500';
                case 'confirmed': 
                case 'Scheduled': return 'bg-blue-100 text-blue-800 border-blue-500';
                case 'Blocked': return 'bg-gray-200 text-gray-600 border-gray-400';
                default: return 'bg-gray-100 text-gray-800 border-gray-300';
            }
        }

        /** Updates the count cards on the dashboard */
        function updateStats(filteredList) {
            const today = new Date().toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' });
            
            // Only count appointments scheduled for today
            const todayAppointments = filteredList.filter(appt => {
                const apptDate = appt.dateTime?.toDate ? new Date(appt.dateTime.toDate()).toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' }) : appt.date;
                return apptDate === today;
            });
            
            const total = todayAppointments.length;
            const completed = todayAppointments.filter(a => a.status === 'Completed').length;
            const pending = todayAppointments.filter(a => a.status !== 'Completed' && a.status !== 'Cancelled' && a.status !== 'Blocked').length; 

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-pending').textContent = Math.max(0, pending);
        }

        /** Formats Firebase Timestamp to "HH:MM AM/PM" */
        function formatFirebaseTimestamp(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') return { time: 'N/A', date: 'N/A' };
            const date = timestamp.toDate();
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            const dateStr = date.toLocaleDateString('en-IN', { year: 'numeric', month: '2-digit', day: '2-digit' });
            return { time: timeStr, date: dateStr };
        }
        
        /** Renders the list of appointments to the table */
        function renderSchedule(data) {
            const listElement = document.getElementById('appointment-list');
            listElement.innerHTML = ''; // Clear existing entries

            if (data.length === 0) {
                listElement.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-500">No upcoming appointments matched the General Practice filter.</td></tr>`;
                updateStats([]);
                return;
            }

            data.forEach(appt => {
                const statusClasses = getStatusClasses(appt.status);
                const isActionable = appt.status !== 'Completed' && appt.status !== 'Cancelled' && appt.status !== 'Blocked';
                
                const formattedTime = appt.formattedTime || appt.time || 'N/A';
                const patientName = appt.patientName || 'Unknown Patient';
                const reasonOrDoctor = appt.doctor || 'Not specified'; // Using doctor field as visit reason
                const symptoms = appt.symptoms || 'â€”';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition duration-150 ease-in-out';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-semibold text-gray-900">${formattedTime}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-primary-blue font-medium cursor-pointer hover:underline">${patientName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden sm:table-cell">${reasonOrDoctor}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden md:table-cell">${symptoms}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 inline-flex text-xs leading-5 font-semibold rounded-full border ${statusClasses}">
                            ${appt.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        ${isActionable ? `
                            <button onclick="window.updateStatus('${appt.id}', 'Completed')" class="text-white bg-green-500 hover:bg-green-600 px-3 py-1 rounded-full text-xs transition mr-2">Complete</button>
                            <button onclick="window.updateStatus('${appt.id}', 'Cancelled')" class="text-red-500 hover:text-red-700 font-medium text-xs">Cancel</button>
                        ` : appt.status === 'Completed' ? '<span class="text-green-600">Reviewed</span>' : 'â€”'}
                    </td>
                `;
                listElement.appendChild(row);
            });
            updateStats(data);
        }

        // Must be attached to window to be callable from HTML button's onclick
        window.updateStatus = async function(id, newStatus) {
            if (!db) return;
            try {
                const apptRef = doc(db, 'appointments', id);
                await updateDoc(apptRef, {
                    status: newStatus
                });
                console.log(`Appointment ${id} updated to: ${newStatus}`);
            } catch (error) {
                console.error("Error updating document: ", error);
                alert(`Failed to update status: ${error.message}`);
            }
        }


        /** Combines filtering and sorting before rendering */
        function applyFiltersAndSort() {
            const statusFilter = document.getElementById('status-filter').value;
            const sortType = document.getElementById('type-sort').value;
            const searchTerm = document.getElementById('patient-search').value.toLowerCase();

            let filtered = currentAppointments.slice(); // Use the global copy of data

            // 1. Filtering by Status
            if (statusFilter !== 'All') {
                filtered = filtered.filter(appt => appt.status === statusFilter);
            }

            // 2. Search by Patient Name
            if (searchTerm) {
                filtered = filtered.filter(appt => 
                    (appt.patientName || '').toLowerCase().includes(searchTerm)
                );
            }

            // 3. Sorting (based on the original Timestamp)
            if (sortType === 'time-asc') {
                filtered.sort((a, b) => a.sortableDate - b.sortableDate);
            } else if (sortType === 'name-asc') {
                filtered.sort((a, b) => (a.patientName || '').localeCompare(b.patientName || ''));
            }

            renderSchedule(filtered);
        }

        /** Sets up the real-time connection to Firebase Firestore */
        function setupRealtimeListener() {
            if (!db) {
                console.error("Firestore not initialized.");
                return;
            }

            const q = query(
                collection(db, 'appointments'),
                orderBy('dateTime', 'asc') // Order by date/time
            );
            
            const specialtiesLower = FILTER_SPECIALTIES.map(s => s.toLowerCase());

            onSnapshot(q, (snapshot) => {
                const allAppointments = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const apptDate = data.dateTime?.toDate ? new Date(data.dateTime.toDate()) : (data.date ? new Date(data.date) : null);
                    
                    if (apptDate && apptDate.getTime() >= Date.now() - (24 * 60 * 60 * 1000)) { // Show upcoming/today
                        
                        // Check if the appointment's 'doctor' or 'symptoms' field
                        // contains ANY of the general specialty strings.
                        const doctorDetails = (data.doctor || '').toLowerCase();
                        const symptoms = (data.symptoms || '').toLowerCase();
                        
                        let isMatch = false;
                        for (const specialty of specialtiesLower) {
                            if (doctorDetails.includes(specialty) || symptoms.includes(specialty)) {
                                isMatch = true;
                                break;
                            }
                        }
                        
                        // Also, ensure it's not one of the *other* specialties (Cardiology, Dentistry, Neurology)
                        // A truly robust system would need a dedicated 'specialty' field in the database, 
                        // but given the current form structure, this prevents overlap.
                        const excludedSpecialties = ["cardiology", "dentistry", "neurology"];
                        let isExcluded = false;
                        for (const excl of excludedSpecialties) {
                            if (doctorDetails.includes(excl)) {
                                isExcluded = true;
                                break;
                            }
                        }


                        if (isMatch && !isExcluded) {
                            const formatted = formatFirebaseTimestamp(data.dateTime);
                            const sortableDate = apptDate.getTime();

                            allAppointments.push({ 
                                id: doc.id, 
                                sortableDate, 
                                formattedTime: formatted.time,
                                ...data 
                            });
                        }
                    }
                });
                
                currentAppointments = allAppointments;
                applyFiltersAndSort(); // Re-apply current filters and render the new data
            }, (error) => {
                console.error("Error listening to appointments: ", error);
                document.getElementById('appointment-list').innerHTML = '<tr><td colspan="6" class="p-6 text-center text-red-500">Failed to load schedule from database.</td></tr>';
            });
        }

        // --- INITIALIZATION ---
        function initializeAppAndAuth() {
            // Set up UI text based on configuration
            document.getElementById('page-title').textContent = `${DOCTOR_SPECIALTY} Dashboard`;
            document.getElementById('header-specialty').textContent = `${DOCTOR_SPECIALTY}`;
            document.getElementById('sidebar-specialty').textContent = `${DOCTOR_SPECIALTY}`;
            document.getElementById('doctor-name-display').textContent = `${DOCTOR_NAME}, ${DOCTOR_SPECIALTY}`;

            // Set current date
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-IN', dateOptions);

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setupRealtimeListener();
            } catch (error) {
                console.error("Initialization Error:", error);
                document.getElementById('appointment-list').innerHTML = `<tr><td colspan="6" class="p-6 text-center text-red-500">App Setup Failed: ${error.message}</td></tr>`;
            }

            // Set up event listeners for filters/search
            document.getElementById('status-filter').addEventListener('change', applyFiltersAndSort);
            document.getElementById('type-sort').addEventListener('change', applyFiltersAndSort);
            document.getElementById('patient-search').addEventListener('input', applyFiltersAndSort);
        }
        
        document.addEventListener('DOMContentLoaded', initializeAppAndAuth);
    </script>
</body>
</html>
